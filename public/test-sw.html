<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SW Debug</title>
  <style>
    body { 
      font-family: monospace; 
      padding: 20px; 
      background: #000; 
      color: #0f0; 
    }
    .error { color: #f00; }
    .success { color: #0f0; }
    .warning { color: #ff0; }
    pre { 
      background: #111; 
      padding: 10px; 
      border: 1px solid #333;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>ğŸ” Service Worker Debug</h1>
  <div id="output"></div>

  <script>
    const out = document.getElementById('output');
    
    function log(msg, type = 'info') {
      const div = document.createElement('div');
      div.className = type;
      div.textContent = msg;
      out.appendChild(div);
      console.log(msg);
    }
    
    async function test() {
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
      log('STARTING DIAGNOSTIC...', 'success');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
      
      // 1. Check location
      log(`\nğŸ“ Location: ${window.location.href}`, 'info');
      log(`ğŸ“ Origin: ${window.location.origin}`, 'info');
      log(`ğŸ“ Pathname: ${window.location.pathname}`, 'info');
      
      // 2. Check SW API
      if (!('serviceWorker' in navigator)) {
        log('\nâŒ Service Worker API NOT supported!', 'error');
        return;
      }
      log('\nâœ… Service Worker API is supported', 'success');
      
      // 3. Check existing registrations
      const existing = await navigator.serviceWorker.getRegistrations();
      log(`\nğŸ“Š Existing registrations: ${existing.length}`, 'info');
      existing.forEach((reg, i) => {
        log(`  ${i+1}. ${reg.scope}`, 'info');
      });
      
      // 4. Test different SW paths
      const paths = [
        '/Graphitube/sw.js',
        '/sw.js',
        'sw.js',
        './sw.js',
        '../sw.js'
      ];
      
      log('\nğŸ” Testing SW file accessibility...', 'info');
      
      for (const path of paths) {
        try {
          const fullUrl = new URL(path, window.location.origin).href;
          log(`\nTesting: ${path}`, 'info');
          log(`Full URL: ${fullUrl}`, 'info');
          
          const response = await fetch(fullUrl);
          
          if (response.ok) {
            log(`âœ… FOUND! Status: ${response.status}`, 'success');
            const text = await response.text();
            log(`Content preview: ${text.substring(0, 100)}...`, 'success');
            
            // Try to register with this path
            log(`\nğŸš€ Attempting registration with: ${path}`, 'info');
            try {
              const reg = await navigator.serviceWorker.register(path, {
                scope: '/Graphitube/'
              });
              log('âœ… âœ… âœ… REGISTRATION SUCCESSFUL!', 'success');
              log(`Scope: ${reg.scope}`, 'success');
              log(`Active: ${reg.active?.state}`, 'success');
              log(`Installing: ${reg.installing?.state}`, 'success');
              
              // Wait for activation
              await new Promise(resolve => setTimeout(resolve, 2000));
              
              const check = await navigator.serviceWorker.getRegistrations();
              log(`\nğŸ“Š Registrations after: ${check.length}`, check.length > 0 ? 'success' : 'error');
              
              return; // Stop on first success
              
            } catch (regError) {
              log(`âŒ Registration failed: ${regError.message}`, 'error');
            }
            
          } else {
            log(`âŒ Not found. Status: ${response.status}`, 'error');
          }
        } catch (err) {
          log(`âŒ Fetch error: ${err.message}`, 'error');
        }
      }
      
      log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
      log('DIAGNOSTIC COMPLETE', 'warning');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    }
    
    test();
  </script>
</body>
</html>
